<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>داشبورد کارمند</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @font-face { font-family: 'Vazirmatn'; src: url('/static/Vazirmatn-regular.ttf'); }
        html.dark { color-scheme: dark; }
        body { font-family: "Vazirmatn", sans-serif; }
        .status-submitted { background-color: #eff6ff; color: #1d4ed8; } .status-approved { background-color: #f0fdf4; color: #166534; } .status-rejected { background-color: #fef2f2; color: #991b1b; }
        html.dark .status-submitted { background-color: #1e3a8a; color: #bfdbfe; } html.dark .status-approved { background-color: #14532d; color: #dcfce7; } html.dark .status-rejected { background-color: #7f1d1d; color: #fecaca; }
        .modal { transition: opacity 0.25s ease; } .modal.hidden { opacity: 0; pointer-events: none; } .modal:not(.hidden) { opacity: 1; }
        .modal > div { transition: transform 0.25s ease; } .modal.hidden > div { transform: scale(0.95); }
        .table-input { width: 80px; text-align: center; border-radius: 5px; border: 1px solid #ccc; padding: 4px; background-color: #f9fafb; }
        html.dark .table-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
    </style>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
<div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 bg-white dark:bg-gray-800 border-l dark:border-gray-700 shadow-sm hidden lg:block">
        <div class="flex flex-col h-full">
            <div class="h-16 flex items-center justify-center border-b dark:border-gray-700"><i class="fas fa-cogs text-blue-600 text-2xl"></i><span class="ml-3 font-bold text-xl text-gray-800 dark:text-white">سیستم مانیتورینگ</span></div>
            <nav class="flex-1 px-4 py-6 space-y-2 text-sm">
                <a href="/employee-dashboard" class="flex items-center mt-2 px-4 py-2.5 text-gray-700 dark:text-white bg-blue-50 dark:bg-blue-900/50 rounded-lg font-semibold"><i class="fas fa-user fa-fw ml-3 text-blue-600"></i>داشبورد من</a>
                <a href="/assembler-dashboard" class="flex items-center px-4 py-2.5 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i class="fas fa-clipboard-check fa-fw ml-3"></i>ثبت گزارش جدید</a>
            </nav>
        </div>
    </aside>
    
    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="h-16 bg-white dark:bg-gray-800 border-b dark:border-gray-700 flex items-center justify-between px-6 flex-shrink-0">
             <h1 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center gap-3"><i class="fas fa-user text-indigo-600"></i><span>داشبورد کارمند</span></h1>
             <div class="flex items-center gap-4">
                 <button id="theme-toggle" class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400"><i class="fas fa-moon" id="theme-toggle-dark-icon"></i><i class="fas fa-sun hidden" id="theme-toggle-light-icon"></i></button>
                 <div class="h-8 border-r border-gray-200 dark:border-gray-600"></div>
                 <div class="relative">
                    <button id="user-menu-button" class="flex items-center gap-2"><span id="userName" class="font-semibold text-sm"></span><i class="fas fa-chevron-down text-xs"></i></button>
                    <div id="user-menu" class="hidden absolute left-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg border dark:border-gray-700 py-1 z-20"><a href="#" id="logoutButton" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-sign-out-alt ml-2"></i>خروج از حساب</a></div>
                 </div>
             </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">گزارش‌های روزانه من</h2>
                    <a href="/assembler-dashboard" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i class="fas fa-plus"></i> ثبت گزارش جدید
                    </a>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700"><tr><th class="px-6 py-3">تاریخ گزارش</th><th class="px-6 py-3 text-center">وضعیت</th><th class="px-6 py-3">یادداشت ناظر</th><th class="px-6 py-3 text-center">عملیات</th></tr></thead><tbody id="reportsTableBody"></tbody></table><div id="loader" class="text-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div><p class="mt-2">درحال بارگذاری...</p></div><div id="noData" class="text-center py-10 hidden"><i class="fas fa-folder-open fa-2x text-gray-400"></i><p class="mt-2 text-gray-500">شما هنوز گزارشی ثبت نکرده‌اید.</p></div></div>
            </div>
        </div>
    </main>
</div>

<!-- Modal -->
<div id="reportModal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center p-4 z-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"><div class="p-5 border-b dark:border-gray-700 flex justify-between items-center"><h3 id="modalTitle" class="text-xl font-semibold"></h3><button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button></div><div id="modalBody" class="p-6 overflow-y-auto"></div></div></div>
<div id="toastContainer" class="fixed bottom-4 right-4 space-y-3 z-[1100]"></div>

<script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- API Helper, Auth, UI Utilities (Identical to supervisor-dashboard) ---
    const api = {
        _fetch: async (url, options = {}) => {
            const token = localStorage.getItem('token');
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) { logout(); throw new Error('Unauthorized'); }
            if (response.status === 204) return;
            const data = await response.json();
            if (!response.ok) throw new Error(data.detail || `HTTP Error ${response.status}`);
            return data;
        },
        get: (url) => api._fetch(url)
    };
    function checkAuth() { if (!localStorage.getItem('token')) window.location.href = '/login'; }
    async function fetchCurrentUser() { try { const user = await api.get('/auth/me'); document.getElementById('userName').textContent = user.name; } catch (e) { console.error(e); } }
    function logout() { localStorage.removeItem('token'); window.location.href = '/login'; }
    const showToast = (message, type = 'info') => {
        const toastId = 'toast-' + Date.now();
        const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
        const icon = { info: 'fa-info-circle', success: 'fa-check-circle', error: 'fa-exclamation-triangle' };
        const toastHtml = `<div id="${toastId}" class="max-w-xs ${colors[type]} text-white text-sm rounded-lg shadow-lg p-3 flex items-center transition-all duration-300 transform translate-x-full" role="alert"><i class="fas ${icon[type]} ml-2"></i><span>${message}</span></div>`;
        document.getElementById('toastContainer').insertAdjacentHTML('beforeend', toastHtml);
        setTimeout(() => document.getElementById(toastId)?.classList.remove('translate-x-full'), 100);
        setTimeout(() => { const t = document.getElementById(toastId); if(t) { t.style.opacity = '0'; t.style.transform = 'translateX(100%)'; setTimeout(() => t.remove(), 500); }}, 4500);
    };
    function setupThemeToggle() {
        const themeToggleBtn = document.getElementById('theme-toggle'), darkIcon = document.getElementById('theme-toggle-dark-icon'), lightIcon = document.getElementById('theme-toggle-light-icon');
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); lightIcon.classList.remove('hidden'); darkIcon.classList.add('hidden'); }
        themeToggleBtn.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); darkIcon.classList.toggle('hidden'); lightIcon.classList.toggle('hidden'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; });
    }

    // --- DOM Elements & State ---
    const DOM = {}; let reportConfig = null; let myReports = [];
    ["reportsTableBody", "loader", "noData", "reportModal", "modalTitle", "modalBody", "closeModalBtn"].forEach(id => DOM[id] = document.getElementById(id));

    // --- Logic ---
    async function fetchMyReports() {
        DOM.loader.style.display = 'block'; DOM.noData.style.display = 'none'; DOM.tableBody.innerHTML = '';
        try {
            myReports = await api.get('/daily-reports/my-reports');
            renderTable(myReports);
        } catch (error) { showToast(error.message, 'error'); } 
        finally { DOM.loader.style.display = 'none'; }
    }

    function renderTable(reports) {
        if (reports.length === 0) { DOM.noData.style.display = 'block'; return; }
        DOM.tableBody.innerHTML = reports.map(r => {
            const statusMap = { submitted: 'status-submitted', approved: 'status-approved', rejected: 'status-rejected' };
            const statusTextMap = { submitted: 'در انتظار بررسی', approved: 'تایید شده', rejected: 'رد شده' };
            return `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${new persianDate(new Date(r.report_date)).format('YYYY/MM/DD')}</td>
                <td class="px-6 py-4 text-center"><span class="px-3 py-1 text-xs font-medium rounded-full ${statusMap[r.status]}">${statusTextMap[r.status]}</span></td>
                <td class="px-6 py-4 text-sm text-gray-500">${r.supervisor_notes || '-'}</td>
                <td class="px-6 py-4 text-center"><button data-id="${r.id}" class="view-btn font-medium text-indigo-600 hover:underline">مشاهده جزئیات</button></td></tr>`;
        }).join('');
    }

    // This function is identical to the one in supervisor-dashboard.html
    function buildReportTable(config, data) {
        let tableHtml = `<div class="space-y-6">`;
        config.rows.forEach((row, rowIndex) => {
            let contentHtml = '';
            if (row.type === 'checkbox') {
                const key = `R${rowIndex}_I0`;
                contentHtml = `<div class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded" ${data[key] ? 'checked' : ''} disabled></div>`;
            } else if (row.type === 'checkbox_group_with_values') {
                contentHtml = `<div class="flex flex-wrap gap-x-6 gap-y-2">`;
                row.items.forEach((item, itemIndex) => { const key = `R${rowIndex}_I${itemIndex}`; contentHtml += `<label class="flex items-center gap-2"><input type="checkbox" class="h-4 w-4 rounded" ${data[key] ? 'checked' : ''} disabled><span>${item.label} (${item.value}%)</span></label>`; });
                contentHtml += `</div>`;
            } else if (row.items) {
                contentHtml = `<div class="flex flex-wrap items-center justify-start gap-x-6 gap-y-3">`;
                row.items.forEach((item, itemIndex) => { if (item) { const key = `R${rowIndex}_I${itemIndex}`; contentHtml += `<div class="text-center"><label class="block text-xs mb-1">${item.label}</label><input type="number" class="table-input" value="${data[key] || '0'}" readonly></div>`; } });
                contentHtml += `</div>`;
            }
            tableHtml += `<div class="grid grid-cols-3 gap-4 items-start border-b dark:border-gray-700 pb-4"><div class="font-semibold col-span-1">${row.title}</div><div class="col-span-2">${contentHtml}</div></div>`;
        });
        return tableHtml + '</div>';
    }

    async function openModal(reportId) {
        const report = myReports.find(r => r.id == reportId);
        if (!report) return;
        if (!reportConfig) reportConfig = await api.get('/daily-reports/config');
        DOM.modalTitle.textContent = `جزئیات گزارش شما - ${new persianDate(new Date(report.report_date)).format('YYYY/MM/DD')}`;
        DOM.modalBody.innerHTML = buildReportTable(reportConfig, report.report_data);
        DOM.reportModal.classList.remove('hidden');
    }
    function closeModal() { DOM.reportModal.classList.add('hidden'); }

    async function init() {
        checkAuth();
        await fetchCurrentUser();
        setupThemeToggle();
        document.getElementById('user-menu-button').addEventListener('click', () => document.getElementById('user-menu').classList.toggle('hidden'));
        document.getElementById('logoutButton').addEventListener('click', logout);
        DOM.closeModalBtn.addEventListener('click', closeModal);
        DOM.reportModal.addEventListener('click', e => { if (e.target === DOM.reportModal) closeModal(); });
        DOM.tableBody.addEventListener('click', e => { if (e.target.classList.contains('view-btn')) openModal(e.target.dataset.id); });
        fetchMyReports();
    }
    init();
});
</script>
</body>
</html>