<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مدیریت پرسنل</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @font-face { font-family: 'Vazirmatn'; src: url('/static/Vazirmatn-regular.ttf'); }
        html.dark { color-scheme: dark; }
        body { font-family: "Vazirmatn", sans-serif; }
        .modal { transition: opacity 0.25s ease; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal:not(.hidden) { opacity: 1; }
        .modal > div { transition: transform 0.25s ease; }
        .modal.hidden > div { transform: scale(0.95); }
    </style>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

<div class="flex h-screen">
<!-- Sidebar (نسخه نهایی و هوشمند) -->
	<aside class="w-64 flex-shrink-0 bg-white dark:bg-gray-800 border-l dark:border-gray-700 shadow-sm hidden lg:block">
		<div class="flex flex-col h-full">
			<div class="h-16 flex items-center justify-center border-b dark:border-gray-700">
				<i class="fas fa-cogs text-blue-600 text-2xl"></i>
				<span class="ml-3 font-bold text-xl text-gray-800 dark:text-white">سیستم مانیتورینگ</span>
			</div>
			<nav class="flex-1 px-4 py-6 space-y-2 text-sm">
				<!-- ========= لینک‌های عمومی برای همه کاربران (کارمند و مدیر) ========= -->
				<a href="/assembler-dashboard" class="nav-link-item flex items-center px-4 py-2.5 rounded-lg">
					<i class="fas fa-users-cog fa-fw ml-3"></i>
					<span>آمار و گزارش کار</span>
				</a>
				<a href="/employee-dashboard" class="nav-link-item flex items-center px-4 py-2.5 rounded-lg">
					<i class="fas fa-user fa-fw ml-3"></i>
					<span>گزارش‌های من</span>
				</a>

				<!-- ========= لینک‌های مخصوص مدیر (Supervisor) ========= -->
				<div class="supervisor-only" style="display: none;">
					<hr class="my-3 border-gray-200 dark:border-gray-700">
					<h6 class="px-4 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">پنل مدیریت</h6>
					<a href="/dashboard" class="nav-link-item flex items-center px-4 py-2.5 rounded-lg">
						<i class="fas fa-tachometer-alt fa-fw ml-3"></i>
						<span>داشبورد اصلی</span>
					</a>
					<a href="/manager" class="nav-link-item flex items-center px-4 py-2.5 rounded-lg">
						<i class="fas fa-user-shield fa-fw ml-3"></i>
						<span>پنل مدیر</span>
					</a>
					<a href="/workshop" class="nav-link-item flex items-center px-4 py-2.5 rounded-lg">
						<i class="fas fa-hard-hat fa-fw ml-3"></i>
						<span>پنل کارگاه</span>
					</a>
					<a href="/reports" class="nav-link-item flex items-center px-4 py-2.5 rounded-lg">
						<i class="fas fa-chart-line fa-fw ml-3"></i>
						<span>گزارش‌های KPI</span>
					</a>
					<div class="pt-4 mt-4 border-t dark:border-gray-700">
						<a href="/personnel-management" class="nav-link-item flex items-center mt-2 px-4 py-2.5 rounded-lg">
							<i class="fas fa-users fa-fw ml-3"></i>
							<span>مدیریت پرسنل</span>
						</a>
						<a href="/supervisor-dashboard" class="nav-link-item flex items-center mt-2 px-4 py-2.5 rounded-lg">
							<i class="fas fa-user-check fa-fw ml-3"></i>
							<span>داشبورد ناظر</span>
						</a>
					</div>
				</div>
			</nav>
		</div>
	</aside>    
    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="h-16 bg-white dark:bg-gray-800 border-b dark:border-gray-700 flex items-center justify-between px-6 flex-shrink-0">
             <h1 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center gap-3"><i class="fas fa-users-cog text-indigo-600"></i><span>مدیریت پرسنل</span></h1>
             <div class="flex items-center gap-4">
                 <button id="theme-toggle" class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400"><i class="fas fa-moon" id="theme-toggle-dark-icon"></i><i class="fas fa-sun hidden" id="theme-toggle-light-icon"></i></button>
                 <div class="h-8 border-r border-gray-200 dark:border-gray-600"></div>
                 <div class="relative">
                    <button id="user-menu-button" class="flex items-center gap-2"><span id="userName" class="font-semibold text-sm"></span><i class="fas fa-chevron-down text-xs"></i></button>
                    <div id="user-menu" class="hidden absolute left-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg border dark:border-gray-700 py-1 z-20"><a href="#" id="logoutButton" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-sign-out-alt ml-2"></i>خروج از حساب</a></div>
                 </div>
             </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white">لیست پرسنل</h2>
                    <button id="addPersonnelBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-all"><i class="fas fa-plus"></i> افزودن پرسنل</button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 dark:text-gray-400"><thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700"><tr><th scope="col" class="px-6 py-3">نام</th><th scope="col" class="px-6 py-3">نام کاربری</th><th scope="col" class="px-6 py-3">نقش</th><th scope="col" class="px-6 py-3 text-center">عملیات</th></tr></thead><tbody id="personnelTableBody"></tbody></table><div id="loader" class="text-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div><p class="mt-2">درحال بارگذاری...</p></div><div id="noData" class="text-center py-10 hidden"><i class="fas fa-box-open fa-2x text-gray-400"></i><p class="mt-2 text-gray-500">هیچ پرسنلی یافت نشد.</p></div></div>
            </div>
        </div>
    </main>
</div>

<!-- Modal -->
<div id="personnelModal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6 border-b dark:border-gray-700"><h3 id="modalTitle" class="text-xl font-semibold text-gray-800 dark:text-white"></h3></div>
        <form id="personnelForm" class="p-6 space-y-4">
            <input type="hidden" id="personnelId">
            <div><label for="personnelName" class="block mb-2 text-sm font-medium">نام و نام خانوادگی</label><input type="text" id="personnelName" class="bg-gray-50 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" required></div>
            <div><label for="personnelUsername" class="block mb-2 text-sm font-medium">نام کاربری</label><input type="text" id="personnelUsername" class="bg-gray-50 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" required></div>
            <div><label for="personnelPassword" class="block mb-2 text-sm font-medium">رمز عبور</label><input type="password" id="personnelPassword" class="bg-gray-50 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5"><small id="passwordHelp" class="text-xs text-gray-500 dark:text-gray-400">برای تغییر رمز عبور، این فیلد را پر کنید. در غیر این صورت خالی بگذارید.</small></div>
            <div><label for="personnelRole" class="block mb-2 text-sm font-medium">نقش</label><select id="personnelRole" class="bg-gray-50 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5"><option value="employee">کارمند (Employee)</option><option value="supervisor">سرپرست (Supervisor)</option></select></div>
        </form>
        <div class="flex items-center justify-end p-4 bg-gray-50 dark:bg-gray-700/50 rounded-b-lg gap-3">
            <button id="cancelBtn" type="button" class="text-gray-500 bg-white hover:bg-gray-100 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-300 rounded-lg border border-gray-200 dark:border-gray-500 text-sm font-medium px-5 py-2.5">انصراف</button>
            <button id="saveBtn" type="submit" form="personnelForm" class="text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">ذخیره</button>
        </div>
    </div>
</div>
<div id="toastContainer" class="fixed bottom-4 right-4 space-y-3 z-[1100]"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- API Helper & Auth ---
    const api = {
        _fetch: async (url, options = {}) => {
            const token = localStorage.getItem('token');
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) { logout(); throw new Error('Unauthorized'); }
            if (response.status === 204) return;
            const data = await response.json();
            if (!response.ok) throw new Error(data.detail || `HTTP Error ${response.status}`);
            return data;
        },
        get: (url) => api._fetch(url),
        post: (url, body) => api._fetch(url, { method: 'POST', body: JSON.stringify(body) }),
        put: (url, body) => api._fetch(url, { method: 'PUT', body: JSON.stringify(body) }),
        delete: (url) => api._fetch(url, { method: 'DELETE' }),
    };
    function checkAuth() { if (!localStorage.getItem('token')) window.location.href = '/login'; }
    async function fetchCurrentUser() { try { const user = await api.get('/auth/me'); if(user.role !== 'supervisor') { alert('شما دسترسی لازم برای مشاهده این صفحه را ندارید.'); window.location.href = '/assembler-dashboard'; } document.getElementById('userName').textContent = user.name; return user; } catch (e) { console.error(e); } }
    function logout() { localStorage.removeItem('token'); window.location.href = '/login'; }

    // --- UI & Utilities ---
    const showToast = (message, type = 'info') => {
        const toastId = 'toast-' + Date.now();
        const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
        const icon = { info: 'fa-info-circle', success: 'fa-check-circle', error: 'fa-exclamation-triangle' };
        const toastHtml = `<div id="${toastId}" class="max-w-xs ${colors[type]} text-white text-sm rounded-lg shadow-lg p-3 flex items-center transition-all duration-300 transform translate-x-full" role="alert"><i class="fas ${icon[type]} ml-2"></i><span>${message}</span></div>`;
        document.getElementById('toastContainer').insertAdjacentHTML('beforeend', toastHtml);
        setTimeout(() => document.getElementById(toastId)?.classList.remove('translate-x-full'), 100);
        setTimeout(() => { const t = document.getElementById(toastId); if(t) { t.style.opacity = '0'; t.style.transform = 'translateX(100%)'; setTimeout(() => t.remove(), 500); }}, 4500);
    };
    function setupThemeToggle() {
        const themeToggleBtn = document.getElementById('theme-toggle'), darkIcon = document.getElementById('theme-toggle-dark-icon'), lightIcon = document.getElementById('theme-toggle-light-icon');
        if (themeToggleBtn) {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); lightIcon.classList.remove('hidden'); darkIcon.classList.add('hidden'); }
            themeToggleBtn.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); darkIcon.classList.toggle('hidden'); lightIcon.classList.toggle('hidden'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; });
        }
    }
    
    // --- START OF NEW/MODIFIED CODE ---
    function setupSidebar(userRole, currentPagePath) {
        const supervisorLinks = document.querySelectorAll('.supervisor-only');
        if (userRole === 'supervisor') {
            supervisorLinks.forEach(link => {
                link.style.display = 'block';
            });
        }
        const navLinks = document.querySelectorAll('.nav-link-item');
        navLinks.forEach(link => {
            link.classList.remove('text-gray-700', 'dark:text-white', 'bg-blue-50', 'dark:bg-blue-900/50', 'font-semibold');
            link.classList.add('text-gray-600', 'dark:text-gray-400', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            const icon = link.querySelector('i');
            if (icon) icon.classList.remove('text-blue-600');
            if (link.getAttribute('href') === currentPagePath) {
                link.classList.add('text-gray-700', 'dark:text-white', 'bg-blue-50', 'dark:bg-blue-900/50', 'font-semibold');
                if (icon) icon.classList.add('text-blue-600');
            }
        });
    }
    // --- END OF NEW/MODIFIED CODE ---

    // --- DOM Elements ---
    const DOM = {};
    ["personnelModal", "addPersonnelBtn", "cancelBtn", "personnelForm", "modalTitle", "personnelId", "personnelName", "personnelUsername", "personnelPassword", "passwordHelp", "personnelRole", "personnelTableBody", "loader", "noData", "saveBtn"].forEach(id => DOM[id] = document.getElementById(id));
    
    const API_URL = '/personnel/';
    let allPersonnelCache = [];

    function openModal(personnel = null) {
        DOM.personnelForm.reset();
        DOM.personnelId.value = personnel ? personnel.id : '';
        DOM.personnelName.value = personnel ? personnel.name : '';
        DOM.personnelUsername.value = personnel ? personnel.username : '';
        DOM.personnelRole.value = personnel ? personnel.role : 'employee';
        DOM.personnelPassword.required = !personnel;
        DOM.passwordHelp.style.display = personnel ? 'block' : 'none';
        DOM.modalTitle.textContent = personnel ? 'ویرایش اطلاعات پرسنل' : 'افزودن پرسنل جدید';
        DOM.personnelModal.classList.remove('hidden');
    }

    function closeModal() { DOM.personnelModal.classList.add('hidden'); }

    async function fetchPersonnel() {
        DOM.loader.style.display = 'block';
        DOM.noData.style.display = 'none';
        DOM.personnelTableBody.innerHTML = '';
        try {
            allPersonnelCache = await api.get(API_URL);
            if (allPersonnelCache.length === 0) {
                DOM.noData.style.display = 'block';
            } else {
                DOM.personnelTableBody.innerHTML = allPersonnelCache.map(p => `
                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${p.name}</td>
                        <td class="px-6 py-4">${p.username}</td>
                        <td class="px-6 py-4">${p.role === 'supervisor' ? 'سرپرست' : 'کارمند'}</td>
                        <td class="px-6 py-4 text-center">
                            <button data-id="${p.id}" class="edit-btn font-medium text-indigo-600 hover:underline ml-4">ویرایش</button>
                            <button data-id="${p.id}" class="delete-btn font-medium text-red-600 hover:underline">حذف</button>
                        </td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('Fetch error:', error);
            DOM.personnelTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">خطا در بارگذاری اطلاعات: ${error.message}</td></tr>`;
        } finally {
            DOM.loader.style.display = 'none';
        }
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const id = DOM.personnelId.value;
        const password = DOM.personnelPassword.value;
        const payload = {
            name: DOM.personnelName.value.trim(),
            username: DOM.personnelUsername.value.trim(),
            role: DOM.personnelRole.value,
            password: password || "will_not_be_used_if_empty",
        };
        if (!id && !password) return showToast('برای کاربر جدید، رمز عبور الزامی است.', 'error');
        if (!payload.name || !payload.username) return showToast('نام و نام کاربری الزامی است.', 'error');
        if (id && !password) delete payload.password;

        const method = id ? 'put' : 'post';
        const url = id ? `${API_URL}${id}` : API_URL;

        DOM.saveBtn.disabled = true; DOM.saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
        try {
            await api[method](url, payload);
            showToast('اطلاعات با موفقیت ذخیره شد.', 'success');
            await fetchPersonnel();
            closeModal();
        } catch (error) { showToast(`خطا: ${error.message}`, 'error'); } 
        finally { DOM.saveBtn.disabled = false; DOM.saveBtn.textContent = 'ذخیره'; }
    }

    async function handleDelete(id) {
        if (!confirm('آیا از حذف این پرسنل اطمینان دارید؟')) return;
        try {
            await api.delete(`${API_URL}${id}`);
            showToast('پرسنل با موفقیت حذف شد.', 'success');
            await fetchPersonnel();
        } catch (error) { showToast(`خطا در حذف: ${error.message}`, 'error'); }
    }

    async function init() {
        checkAuth();
        const currentUser = await fetchCurrentUser();
        setupThemeToggle();
        
        // --- ADDED CODE ---
        if(currentUser) {
            setupSidebar(currentUser.role, window.location.pathname);
        }
        // --- END OF ADDED CODE ---

        document.getElementById('user-menu-button').addEventListener('click', () => document.getElementById('user-menu').classList.toggle('hidden'));
        document.getElementById('logoutButton').addEventListener('click', logout);
        DOM.addPersonnelBtn.addEventListener('click', () => openModal());
        DOM.cancelBtn.addEventListener('click', closeModal);
        DOM.personnelModal.addEventListener('click', (e) => { if (e.target === DOM.personnelModal) closeModal(); });
        DOM.personnelForm.addEventListener('submit', handleFormSubmit);

        DOM.personnelTableBody.addEventListener('click', (e) => {
            const target = e.target;
            const id = target.dataset.id;
            if (target.classList.contains('edit-btn')) {
                const personnel = allPersonnelCache.find(p => p.id == id);
                if (personnel) openModal(personnel);
            }
            if (target.classList.contains('delete-btn')) {
                handleDelete(id);
            }
        });
        
        fetchPersonnel();
    }
    
    init();
});
</script>
</body>
</html>